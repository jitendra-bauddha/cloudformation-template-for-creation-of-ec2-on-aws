{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Description": "AWS EC2 (Virtual Machine) setup in ap-south-1",
  "Parameters": {
  "NetworkStackName": {
      "Description": "Name of an active CloudFormation stack that contains the networking resources, such as the subnet and security group, that will be used in this stack.",
      "Type": "String",
      "MinLength" : 1,
      "MaxLength" : 255,
      "AllowedPattern" : "^[a-zA-Z][-a-zA-Z0-9]*$",
      "Default" : "JITENDRA"
    },
	"IamRoleStackName": {
      "Description": "Name of an active CloudFormation stack that contains the networking resources, such as the subnet and security group, that will be used in this stack.",
      "Type": "String",
      "MinLength" : 1,
      "MaxLength" : 255,
      "AllowedPattern" : "^[a-zA-Z][-a-zA-Z0-9]*$",
      "Default" : "JITENDRA-IAM-ROLES"
    },
	"InstanceType": {
		"Description": "Type the instance",
		"Type": "String",
		"Default": "t2.micro"
	},
	"InstanceAMIId": {
		"Description": "Type the base ami id",
		"Type": "String",
		"Default": "ami-02d61ede77bfaf074"
	},
	"ec2RootVolumeSize": {
		"Description": "RootVolumeSize minimum value in GB",
		"Type": "Number",
		"MinValue": 10
	},
	"AppServerKeys": {
      "Description" : "Name of an existing EC2 KeyPair to VPN Server",
      "Type": "AWS::EC2::KeyPair::KeyName",
      "ConstraintDescription" : "Must be the name of an existing EC2 KeyPair."
	}
	},
  "Resources": {
	"ProdVpnInstanceProfile" : {
		"Type" : "AWS::IAM::InstanceProfile",
		"Properties" : {
		"Path" : "/",
		"Roles" : [{ "Fn::ImportValue" : {"Fn::Sub": "${IamRoleStackName}-VpnServerRoleName"}}]
		}
	},
	"ProdWebInstanceProfile" : {
		"Type" : "AWS::IAM::InstanceProfile",
		"Properties" : {
		"Path" : "/",
		"Roles" : [{ "Fn::ImportValue" : {"Fn::Sub": "${IamRoleStackName}-WebServerRoleName"}}]
		}
	},
	"ProdDbInstanceProfile" : {
		"Type" : "AWS::IAM::InstanceProfile",
		"Properties" : {
		"Path" : "/",
		"Roles" : [{ "Fn::ImportValue" : {"Fn::Sub": "${IamRoleStackName}-DbServerRoleName"}}]
		}
	},
 "AppServerSG01": {
      "Type": "AWS::EC2::SecurityGroup",
      "Properties": {
        "GroupDescription": {"Fn::Join" : ["-", [{ "Fn::ImportValue" : {"Fn::Sub": "${NetworkStackName}-envPrefix"}},"APP-SERVER-SG"]]},
		"GroupName": {"Fn::Join" : ["-", [{ "Fn::ImportValue" : {"Fn::Sub": "${NetworkStackName}-envPrefix"}},"APP-SERVER-SG"]]},
        "VpcId": { "Fn::ImportValue" : {"Fn::Sub": "${NetworkStackName}-VPCID"}},
 		"SecurityGroupIngress":
			[
				{"IpProtocol": "tcp","FromPort": "80","ToPort": "80","CidrIp": "0.0.0.0/0"},
				{"IpProtocol": "tcp","FromPort": "443","ToPort": "443","CidrIp": "0.0.0.0/0"},
				{"IpProtocol": "tcp","FromPort": "22","ToPort": "22","CidrIp": "0.0.0.0/0"}
			],
		"SecurityGroupEgress":
			[
				{ "IpProtocol": "-1", "CidrIp": "0.0.0.0/0"}
			],
        "Tags":
			[
				{ "Key": "Name", "Value": {"Fn::Join" : ["-", [{ "Fn::ImportValue" : {"Fn::Sub": "${NetworkStackName}-envPrefix"}},"APP-SERVER-SG"]]}},
				{ "Key": "appname", "Value": "your-domain.com"},
				{ "Key": "businessunit", "Value": "default" },
				{ "Key": "environment", "Value": "production" },
				{ "Key": "remarks", "Value": "public;to access dev app server on port 80 and 443" }
			]
      }
    },
 "AppEc2Instance01": {
      "Type": "AWS::EC2::Instance",
      "DependsOn": ["AppServerSG01"],
      "Properties": {
        "DisableApiTermination": "false",
        "InstanceInitiatedShutdownBehavior": "stop",
		"IamInstanceProfile": {
					"Ref": "ProdWebInstanceProfile"},
		"ImageId": {
						"Ref": "InstanceAMIId"
					},			
		"InstanceType": {
						"Ref": "InstanceType"
					},
        "KeyName": {"Ref": "AppServerKeys"},
		"Monitoring": "true",
		"BlockDeviceMappings": [
			{
				"DeviceName": "/dev/xvda",
				"Ebs": {
					"DeleteOnTermination": "true",
					"VolumeSize": {
						"Ref": "ec2RootVolumeSize"
					}
				}
			}
		],
 		"Tags": 
			[
				{ "Key": "Name", "Value": {"Fn::Join" : ["-", [{ "Fn::ImportValue" : {"Fn::Sub": "${NetworkStackName}-envPrefix"}},"APP-SERVER-1A"]]}},
				{ "Key": "backup","Value": "yes:f=1d:r=7d" },
				{ "Key": "appname","Value": "your-domain.com" },
				{ "Key": "businessunit", "Value": "your-domain.com" },
				{ "Key": "cluster", "Value": "na" },
				{ "Key": "environment","Value": "production" },
			    { "Key": "ownername", "Value": "your-domain.com" },
				{ "Key": "role","Value": "app" },
				{ "Key": "starttime","Value": "na" },
				{ "Key": "stoptime", "Value": "na" },
				{ "Key": "project",  "Value": "your-domain.com" }
			],
        "NetworkInterfaces": [
          {
            "DeleteOnTermination": "true",
            "Description": "Primary network interface",
            "DeviceIndex": 0,
            "SubnetId": { "Fn::ImportValue" : {"Fn::Sub": "${NetworkStackName}-WebSubnet1ID"}},
            "GroupSet": [
              {
                "Ref": "AppServerSG01"
              }
            ]
          }
		  ]
		}
     }
   },
   	"Outputs": {
		"AppEc2Instance01": 
		{
			"Value": {"Ref": "AppEc2Instance01"},"Export": {"Name": {"Fn::Sub": "${AWS::StackName}-AppEc2Instance01"}}
		},
		"AppServerSG01": 
			{
			"Value": {"Ref": "AppServerSG01"},"Export": {"Name": {"Fn::Sub": "${AWS::StackName}-AppServerSG01"}}
			}
	}
}